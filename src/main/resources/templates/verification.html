<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>이메일 인증</title>
    <style>
        .disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #verificationSection {
            display: none; /* 처음에는 숨김 */
        }
    </style>
</head>
<body>
<h1>이메일 인증</h1>
<p>인증할 이메일: <strong th:text="${email}"></strong></p> <!-- 세션에서 이메일 표시 -->
<input type="hidden" id="emailInput" name="email" th:value="${email}"> <!-- 이메일 숨겨진 필드 -->

<!-- 인증번호 전송 버튼 -->
<button id="sendButton">인증번호 보내기</button>

<!-- 인증번호 입력 섹션 -->
<div id="verificationSection">
    <p>이메일로 전송된 인증 코드를 입력하세요.</p>
    <label for="verificationCode">인증 코드:</label>
    <input type="text" id="verificationCode" name="code" required>
    <button id="verifyButton">인증하기</button>

    <button id="resendButton" class="disabled" disabled>인증 코드 재발송</button>
    <p id="countdown">3:00</p> <!-- 카운트다운 표시 -->
</div>

<script>
    let countdown = 180; // 3분 (180초)
    const resendButton = document.getElementById('resendButton');
    const countdownDisplay = document.getElementById('countdown');
    const verificationSection = document.getElementById('verificationSection');

    const startCountdown = () => {
        const interval = setInterval(() => {
            countdown--;
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            countdownDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (countdown <= 0) {
                clearInterval(interval);
                resendButton.disabled = false;
                resendButton.classList.remove('disabled');
            }
        }, 1000);
    };

    document.getElementById('sendButton').addEventListener('click', () => {
        const email = document.getElementById('emailInput').value; // 이메일 값을 가져옴
        document.getElementById('sendButton').disabled = true;
        fetch('/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                email: email // 이메일 값을 포함
            })
        })
            .then(response => {
                if (response.ok) {
                    alert('인증번호가 이메일로 전송되었습니다.');
                    verificationSection.style.display = 'block'; // 인증번호 입력 섹션 표시
                    countdown = 180; // 카운트다운 초기화
                    resendButton.disabled = true;
                    resendButton.classList.add('disabled');
                    startCountdown();
                } else {
                    alert('인증번호 전송에 실패했습니다. 다시 시도해 주세요.');
                }
            });
    });

    document.getElementById('verifyButton').addEventListener('click', () => {
        const email = document.getElementById('emailInput').value;
        const code = document.getElementById('verificationCode').value;
        fetch('/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                email: email, // 이메일 값을 포함
                code : code
            })
        })
            .then(response => {
                if (response.ok) {
                    alert('이메일 인증이 완료되었습니다.');
                    verificationSection.style.display = 'block'; // 인증번호 입력 섹션 표시
                    countdown = 180; // 카운트다운 초기화
                    resendButton.disabled = true;
                    resendButton.classList.add('disabled');
                    window.location.href = "/"
                } else {
                    alert('인증에 실패했습니다.. 다시 시도해 주세요.');
                }
            });
    });

    resendButton.addEventListener('click', () => {
        const email = document.getElementById('emailInput').value; // 이메일 값을 가져옴
        fetch('/resend-verification-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                email: email // 이메일 값을 포함
            })
        })
            .then(response => {
                if (response.ok) {
                    alert('인증 이메일이 재전송되었습니다.');
                    countdown = 180; // 카운트다운 초기화
                    resendButton.disabled = true;
                    resendButton.classList.add('disabled');
                    startCountdown();
                } else {
                    alert('재전송에 실패했습니다. 다시 시도해 주세요.');
                }
            });
    });
</script>
</body>
</html>
